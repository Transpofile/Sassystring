<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <title>Enhanced GMaster Decript Data</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
    <link crossorigin="" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+e2k0b+U5bA82wz3oKzCofjK/gW/8dG/bJ9e2/epc=" rel="stylesheet"/>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #locationMap {
            height: 320px;
            border-radius: 0.5rem;
            border: 1px solid #cbd5e1; /* Tailwind gray-300 */
            margin-top: 1rem;
            background-color: #f1f5f9; /* Tailwind gray-100 for loading */
        }
        /* Responsive tabs: stack vertically on small screens */
        @media (max-width: 640px) {
            nav[aria-label="Tabs"] {
                flex-wrap: wrap;
            }
            nav[aria-label="Tabs"] button {
                flex: 1 1 50%;
                text-align: center;
                padding-left: 0.5rem;
                padding-right: 0.5rem;
                border-bottom-width: 3px !important;
            }
        }
        /* Modal backdrop */
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
        }
        /* Scrollable device list */
        #networkDevicesList {
            max-height: 240px; /* Increased height */
            overflow-y: auto;
        }
        /* Custom focus rings for better accessibility */
        :focus-visible {
            outline: 3px solid #60a5fa; /* Tailwind blue-400 */
            outline-offset: 2px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
<header class="bg-gradient-to-r from-blue-700 to-blue-900 text-white shadow-md">
    <div class="container mx-auto px-4 py-5 flex flex-col md:flex-row items-center justify-between">
        <div class="flex items-center space-x-3">
            <img alt="Logo icon with letters PT in white on blue background" class="w-12 h-12 rounded-full border-2 border-blue-300" height="48" src="https://storage.googleapis.com/a1aa/image/3c897f4d-fdc8-495f-5aec-870e7561f4d7.jpg" width="48"/>
            <h1 class="text-2xl font-semibold tracking-wide">GMaster Decript Data</h1>
        </div>
        <nav class="mt-4 md:mt-0">
            <ul class="flex space-x-6 text-sm font-medium">
                <li><a class="hover:underline focus:underline" href="#tracker">Tracker</a></li>
                <li><a class="hover:underline focus:underline" href="#history">History</a></li>
                <li><a class="hover:underline focus:underline" href="#about">About</a></li>
            </ul>
        </nav>
    </div>
</header>
<main class="flex-grow container mx-auto px-4 py-8 max-w-4xl">
    <section class="bg-white rounded-lg shadow-md p-6" id="tracker">
        <h2 class="text-3xl font-semibold mb-6 text-center text-blue-900">GMaster Data Toolkit</h2>
        <div>
            <div class="border-b border-gray-300 mb-6">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs" role="tablist">
                    <button id="tab-phone" type="button" class="whitespace-nowrap py-4 px-1 border-b-2 border-blue-700 text-blue-700 font-semibold text-lg" aria-selected="true" role="tab" aria-controls="panel-phone" tabindex="0">Phone Number</button>
                    <button id="tab-facebook" type="button" class="whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-semibold text-lg" aria-selected="false" role="tab" aria-controls="panel-facebook" tabindex="-1">Facebook Profile</button>
                    <button id="tab-hack" type="button" class="whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-semibold text-lg" aria-selected="false" role="tab" aria-controls="panel-hack" tabindex="-1">Hack Simulation</button>
                    <button id="tab-location" type="button" class="whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-semibold text-lg" aria-selected="false" role="tab" aria-controls="panel-location" tabindex="-1">Location Map</button>
                    <button id="tab-network" type="button" class="whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-semibold text-lg" aria-selected="false" role="tab" aria-controls="panel-network" tabindex="-1">Network Scan</button>
                </nav>
            </div>
            <form autocomplete="off" class="space-y-6" id="trackerForm" novalidate="">
                <div id="panel-phone" role="tabpanel" tabindex="0" aria-labelledby="tab-phone">
                    <label class="block text-gray-700 font-semibold mb-2" for="phone">Phone Number</label>
                    <input aria-describedby="phoneHelp" class="w-full border border-gray-300 rounded-md px-4 py-3 focus:border-blue-500 focus:ring-blue-500" id="phone" name="phone" pattern="^(09|\+639)[0-9]{9}$" placeholder="e.g., 09171234567" type="tel"/>
                    <p class="text-xs text-gray-500 mt-1" id="phoneHelp">Enter a valid Philippine phone number.</p>
                </div>
                <div id="panel-facebook" role="tabpanel" tabindex="0" aria-labelledby="tab-facebook" class="hidden">
                    <label class="block text-gray-700 font-semibold mb-2" for="facebook">Facebook Profile Link</label>
                    <input aria-describedby="facebookHelp" class="w-full border border-gray-300 rounded-md px-4 py-3 focus:border-blue-500 focus:ring-blue-500" id="facebook" name="facebook" pattern="https?://(www\.)?facebook\.com/.+" placeholder="e.g., https://www.facebook.com/zuck" type="url"/>
                    <p class="text-xs text-gray-500 mt-1" id="facebookHelp">Enter a valid Facebook profile URL.</p>
                </div>
                <div id="panel-hack" role="tabpanel" tabindex="0" aria-labelledby="tab-hack" class="hidden space-y-4">
                    <div class="p-4 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800">
                        <p><i class="fas fa-exclamation-triangle mr-2"></i>This is a simulation for educational purposes only.</p>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2" for="hackPhone">Target Phone Number</label>
                        <input class="w-full border border-gray-300 rounded-md px-4 py-3 focus:border-red-500 focus:ring-red-500" id="hackPhone" name="hackPhone" pattern="^(09|\+639)[0-9]{9}$" placeholder="Target Phone Number" type="tel"/>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2" for="hackFacebook">Target Facebook Profile</label>
                        <input class="w-full border border-gray-300 rounded-md px-4 py-3 focus:border-red-500 focus:ring-red-500" id="hackFacebook" name="hackFacebook" pattern="https?://(www\.)?facebook\.com/.+" placeholder="Target Facebook Profile URL" type="url"/>
                    </div>
                    <div class="flex flex-col md:flex-row md:space-x-4 space-y-4 md:space-y-0">
                        <button aria-label="Attempt hack" class="flex-1 bg-red-700 hover:bg-red-800 text-white font-semibold py-3 rounded-md transition-colors duration-300 justify-center items-center inline-flex disabled:bg-red-400" id="hackBtn" type="button">
                            <i class="fas fa-skull-crossbones mr-2"></i> Attempt Exploit
                        </button>
                        <button aria-label="Generate hack data" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 rounded-md transition-colors duration-300 justify-center items-center inline-flex" id="generateHackBtn" type="button">
                            <i class="fas fa-magic mr-2"></i> Generate Target
                        </button>
                    </div>
                </div>
                <div id="panel-location" role="tabpanel" tabindex="0" aria-labelledby="tab-location" class="hidden">
                    <div id="locationMap" aria-label="Interactive map showing locations"></div>
                </div>
                <div id="panel-network" role="tabpanel" tabindex="0" aria-labelledby="tab-network" class="hidden">
                    <div class="mb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <h3 class="text-lg font-semibold text-gray-800">Local Network Devices</h3>
                        <button id="scanNetworkBtn" type="button" class="bg-blue-700 hover:bg-blue-800 text-white font-semibold py-2 px-4 rounded-md inline-flex items-center disabled:bg-blue-400 w-full sm:w-auto justify-center">
                            <i class="fas fa-network-wired mr-2"></i> Scan Network
                        </button>
                    </div>
                    <div id="networkDevicesList" class="border border-gray-300 rounded-md p-4 bg-white" aria-live="polite" role="region" tabindex="0">
                        <p class="text-gray-500 italic">No network scan performed yet.</p>
                    </div>
                </div>
                <div class="flex flex-col md:flex-row md:space-x-4 space-y-4 md:space-y-0">
                    <button aria-label="Track phone and Facebook link" class="flex-1 bg-blue-700 hover:bg-blue-800 text-white font-semibold py-3 rounded-md transition-colors duration-300 justify-center items-center inline-flex disabled:bg-blue-400" id="trackBtn" type="submit">
                        <i class="fas fa-search-location mr-2"></i> Track Data
                    </button>
                    <button aria-label="Generate random data" class="flex-1 bg-green-700 hover:bg-green-800 text-white font-semibold py-3 rounded-md transition-colors duration-300 justify-center items-center inline-flex" id="generateBtn" type="button">
                        <i class="fas fa-magic mr-2"></i> Generate Demo Data
                    </button>
                </div>
            </form>
        </div>
        <div class="mt-8 hidden bg-blue-50 border border-blue-200 rounded-md p-6" id="result" role="region" aria-live="polite">
            <h3 class="text-xl font-semibold text-blue-900 mb-4 border-b pb-2">Tracking Results</h3>
            <div id="hackResult" class="hidden mb-4 p-4 rounded-md font-semibold text-base" role="alert"></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-8">
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2 flex items-center"><i class="fas fa-phone-alt text-blue-700 mr-2"></i>Phone Number Details</h4>
                    <p class="text-gray-700 text-lg font-mono" id="phoneOutput"></p>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-800 mb-2 flex items-center"><i class="fab fa-facebook text-blue-700 mr-2"></i>Facebook Profile Details</h4>
                    <div class="flex items-start space-x-4">
                        <img alt="Facebook profile picture" class="w-16 h-16 rounded-full object-cover border-2 border-gray-300 flex-shrink-0" height="64" id="fbProfilePic" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" width="64"/>
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-900 text-lg" id="fbName"></p>
                             <!-- Enhanced: Links for app and web -->
                            <div class="mt-2 flex items-center space-x-3">
                                <a id="fbAppLink" href="#" rel="noopener noreferrer" target="_blank" title="Requires Facebook app to be installed" class="inline-flex items-center px-3 py-1 bg-blue-600 text-white text-xs font-semibold rounded-md hover:bg-blue-700">
                                    <i class="fab fa-facebook-messenger mr-1.5"></i> Open in App
                                </a>
                                <a id="fbWebLink" href="#" rel="noopener noreferrer" target="_blank" class="text-xs text-blue-700 hover:underline">View on Web</a>
                            </div>
                        </div>
                    </div>
                     <!-- Enhanced: Extra simulated details -->
                    <div id="fbExtraDetails" class="mt-4 space-y-2 text-sm text-gray-700"></div>
                </div>
            </div>
             <div id="networkFavIconSection" class="mt-6 hidden">
                <h4 class="font-semibold text-gray-800 mb-3 flex items-center"><i class="fas fa-wifi text-blue-700 mr-2"></i>Detected Network Devices</h4>
                <ul id="networkFavIconList" class="flex flex-wrap gap-4"></ul>
            </div>
        </div>
    </section>
    <!-- ... (rest of the HTML is unchanged) ... -->
    <section class="mt-12" id="history">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-semibold text-blue-900">Tracking History</h2>
            <button id="clearHistoryBtn" class="text-sm text-red-600 hover:text-red-800 font-medium hidden"><i class="fas fa-trash-alt mr-1"></i> Clear History</button>
        </div>
        <div class="bg-white rounded-lg shadow-md p-2 sm:p-6 max-h-96 overflow-y-auto">
            <div class="overflow-x-auto">
                <table class="w-full table-auto border-collapse text-left text-gray-700" role="table" aria-label="Tracking history table">
                    <thead class="bg-blue-100 sticky top-0">
                        <tr>
                            <th class="px-4 py-2 border border-blue-200" scope="col">Phone</th>
                            <th class="px-4 py-2 border border-blue-200" scope="col">Name</th>
                            <th class="px-4 py-2 border border-blue-200" scope="col">Tracked At</th>
                            <th class="px-4 py-2 border border-blue-200" scope="col">Location</th>
                            <th class="px-4 py-2 border border-blue-200" scope="col">Hack Status</th>
                            <th class="px-4 py-2 border border-blue-200" scope="col">Devices</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-blue-100" id="historyTableBody"></tbody>
                </table>
            </div>
            <p class="text-center text-gray-500 mt-4 py-4" id="noHistory">No tracking history yet.</p>
        </div>
    </section>
    <section class="mt-12 bg-white rounded-lg shadow-md p-6" id="about">
        <h2 class="text-2xl font-semibold mb-4 text-blue-900">About This System</h2>
        <p class="text-gray-700 leading-relaxed">This enhanced GMaster Data Toolkit simulates data retrieval and analysis from various sources. It provides a feature-rich interface to demonstrate concepts of data correlation, location tracking, and network scanning in a safe, simulated environment. All data is generated for demonstrative purposes and interactions are simulations of cloud-based services.</p>
    </section>
</main>
<footer class="bg-blue-900 text-white py-6 mt-12">
    <div class="container mx-auto px-4 text-center text-sm">© 2024 GMaster Decript Data. All rights reserved.</div>
</footer>

<!-- Modal -->
<div id="codeModal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 p-6 relative">
        <h3 id="modalTitle" class="text-xl font-semibold mb-4 text-blue-900">Generated Data Record</h3>
        <pre id="modalCode" class="bg-gray-100 p-4 rounded text-sm overflow-x-auto max-h-80" tabindex="0"></pre>
        <button id="modalCloseBtn" class="absolute top-3 right-3 text-gray-600 hover:text-gray-900" aria-label="Close modal">
            <i class="fas fa-times fa-lg"></i>
        </button>
    </div>
</div>

<script crossorigin="" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- DOM Elements ---
    const tabElements = {
        phone: document.getElementById('tab-phone'),
        facebook: document.getElementById('tab-facebook'),
        hack: document.getElementById('tab-hack'),
        location: document.getElementById('tab-location'),
        network: document.getElementById('tab-network'),
    };
    const panelElements = {
        phone: document.getElementById('panel-phone'),
        facebook: document.getElementById('panel-facebook'),
        hack: document.getElementById('panel-hack'),
        location: document.getElementById('panel-location'),
        network: document.getElementById('panel-network'),
    };
    const form = document.getElementById('trackerForm');
    const trackBtn = document.getElementById('trackBtn');
    const generateBtn = document.getElementById('generateBtn');
    const hackBtn = document.getElementById('hackBtn');
    const generateHackBtn = document.getElementById('generateHackBtn');
    const scanNetworkBtn = document.getElementById('scanNetworkBtn');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');
    const resultSection = document.getElementById('result');
    const historyTableBody = document.getElementById('historyTableBody');
    const noHistoryMsg = document.getElementById('noHistory');
    const codeModal = document.getElementById('codeModal');
    const modalCode = document.getElementById('modalCode');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    let map, phoneMarker, fbMarker, hackMarker, lineBetween;
    let currentNetworkDevices = [];

    // --- Tab Functionality ---
    const activateTab = (tabName) => {
        Object.values(tabElements).forEach(t => {
            t.classList.remove('border-blue-700', 'text-blue-700');
            t.classList.add('border-transparent', 'text-gray-500');
            t.setAttribute('aria-selected', 'false');
            t.setAttribute('tabindex', '-1');
        });
        Object.values(panelElements).forEach(p => p.classList.add('hidden'));

        tabElements[tabName].classList.add('border-blue-700', 'text-blue-700');
        tabElements[tabName].classList.remove('border-transparent', 'text-gray-500');
        tabElements[tabName].setAttribute('aria-selected', 'true');
        tabElements[tabName].setAttribute('tabindex', '0');
        panelElements[tabName].classList.remove('hidden');

        if (tabName === 'location' && map) {
            setTimeout(() => map.invalidateSize(), 100);
        }

        const isActionTab = ['phone', 'facebook'].includes(tabName);
        trackBtn.style.display = isActionTab ? 'inline-flex' : 'none';
        generateBtn.style.display = isActionTab ? 'inline-flex' : 'none';
    };

    Object.keys(tabElements).forEach(key => {
        tabElements[key].addEventListener('click', () => activateTab(key));
    });

    // --- Utility Functions ---
    const showToast = (message, type = 'info') => {
        const toast = document.createElement('div');
        const colors = {
            info: 'bg-blue-600',
            success: 'bg-green-600',
            error: 'bg-red-600',
        };
        toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-md text-white ${colors[type]} shadow-lg transition-transform duration-300 transform translate-y-16 z-50`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.classList.remove('translate-y-16'), 10);
        setTimeout(() => {
            toast.classList.add('translate-y-16');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    };

    const toggleButtonState = (button, isLoading, loadingText = 'Processing...', originalHTML) => {
        if (isLoading) {
            button.disabled = true;
            button.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> ${loadingText}`;
        } else {
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    };

    const formatPhoneNumber = (phone) => {
        let cleaned = phone.replace(/\s+/g, '').replace(/[^0-9+]/g, '');
        if (cleaned.startsWith('09')) {
            cleaned = '+63' + cleaned.slice(1);
        }
        return cleaned;
    };

    const validateInput = (value, pattern) => pattern.test(value);

    // --- Data Simulation ("Cloud Interaction") ---
    const generateRandomPhone = () => `09${Math.floor(100000000 + Math.random() * 900000000)}`;
    
    const generateRandomFacebook = () => {
        const names = ['alpha.sierra', 'bravo.zulu', 'charlie.delta', 'echo.fox', 'golf.hotel'];
        return `https://www.facebook.com/${names[Math.floor(Math.random() * names.length)]}${Math.floor(Math.random() * 100)}`;
    };

    // ENHANCEMENT: Generate richer, more realistic-looking data.
    const fetchFacebookProfileData = (url) => {
        try {
            const path = new URL(url).pathname.replace(/\//g, '');
            const name = path.split(/[\.\-_]/).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            const initials = name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
            const profilePicUrl = `https://placehold.co/80x80/4267B2/FFFFFF?text=${encodeURIComponent(initials)}&font=Inter`;
            
            const locations = [
                { city: 'Manila', lat: 14.5995, lon: 120.9842 }, { city: 'Cebu City', lat: 10.3157, lon: 123.8854 },
                { city: 'Davao City', lat: 7.1907, lon: 125.4553 }, { city: 'Quezon City', lat: 14.6760, lon: 121.0437 }
            ];
            const hometowns = ['Bacolod', 'Iloilo', 'Zamboanga', 'Taguig'];
            const statuses = ['Single', 'In a relationship', 'It\'s complicated', 'Married'];

            return { 
                name, 
                profilePicUrl, 
                profileUrl: url, 
                fbLocation: locations[Math.floor(Math.random() * locations.length)],
                hometown: hometowns[Math.floor(Math.random() * hometowns.length)],
                status: statuses[Math.floor(Math.random() * statuses.length)],
            };
        } catch {
            return { name: 'Invalid User', profilePicUrl: 'https://placehold.co/80x80/cccccc/000000?text=?', profileUrl: url, fbLocation: { city: 'Unknown', lat: 14.5995, lon: 120.9842 }, hometown: 'N/A', status: 'N/A' };
        }
    };

    const estimatePhoneLocation = (phone) => {
        const prefix = phone.substring(3, 6);
        const prefixMap = {
            '917': { city: 'Makati', lat: 14.5547, lon: 121.0244 }, '918': { city: 'Pasig', lat: 14.5764, lon: 121.0851 },
            '919': { city: 'Baguio', lat: 16.4023, lon: 120.5960 }, '920': { city: 'Iloilo City', lat: 10.7202, lon: 122.5621 }
        };
        return prefixMap[prefix] || { city: 'Philippines', lat: 12.8797, lon: 121.7740 };
    };
    
    const generateNetworkDevices = () => {
        const deviceTypes = [
            { type: 'Laptop', icon: 'fas fa-laptop-code', names: ['Dell XPS 13', 'MacBook Pro', 'ThinkPad T14'] },
            { type: 'Smartphone', icon: 'fas fa-mobile-alt', names: ['iPhone 14', 'Galaxy S23', 'Pixel 7'] },
            { type: 'Router', icon: 'fas fa-wifi', names: ['Netgear Nighthawk', 'TP-Link Archer', 'Asus RT-AX88U'] },
            { type: 'Smart TV', icon: 'fas fa-tv', names: ['Samsung Smart TV', 'LG OLED', 'Sony Bravia'] },
            { type: 'Game Console', icon: 'fas fa-gamepad', names: ['PlayStation 5', 'Xbox Series X', 'Nintendo Switch'] }
        ];
        const count = Math.floor(Math.random() * 4) + 2; // 2 to 5 devices
        const devices = new Set();
        while (devices.size < count) {
            const dt = deviceTypes[Math.floor(Math.random() * deviceTypes.length)];
            devices.add({ ...dt, name: dt.names[Math.floor(Math.random() * dt.names.length)] });
        }
        return Array.from(devices);
    };

    // --- UI Rendering ---
    const initMap = () => {
        if (map) return;
        map = L.map('locationMap', { scrollWheelZoom: false }).setView([12.8797, 121.7740], 5.5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18, attribution: '© OpenStreetMap'
        }).addTo(map);
    };

    const updateMap = (locations) => {
        initMap();
        [phoneMarker, fbMarker, hackMarker, lineBetween].forEach(layer => layer && map.removeLayer(layer));
        
        const icons = {
            phone: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] }),
            fb: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-violet.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] }),
            hack: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] })
        };
        
        const markers = [];
        if (locations.phone) {
            phoneMarker = L.marker([locations.phone.lat, locations.phone.lon], { icon: icons.phone }).addTo(map).bindPopup(`<b>Phone Location</b><br>${locations.phone.city}`);
            markers.push(phoneMarker);
        }
        if (locations.fb) {
            fbMarker = L.marker([locations.fb.lat, locations.fb.lon], { icon: icons.fb }).addTo(map).bindPopup(`<b>Facebook Location</b><br>${locations.fb.city}`);
            markers.push(fbMarker);
        }
        if (locations.hack) {
            hackMarker = L.marker([locations.hack.lat, locations.hack.lon], { icon: icons.hack }).addTo(map).bindPopup(`<b>Hack Location</b><br>${locations.hack.city}`);
            markers.push(hackMarker);
        }

        if (markers.length > 1) {
            lineBetween = L.polyline(markers.map(m => m.getLatLng()), { color: 'red', dashArray: '5, 5', weight: 2 }).addTo(map);
            map.fitBounds(L.featureGroup(markers).getBounds().pad(0.3));
        } else if (markers.length === 1) {
            map.setView(markers[0].getLatLng(), 13);
        }
    };

    const renderNetworkDevicesList = (devices) => {
        const listContainer = document.getElementById('networkDevicesList');
        if (!devices || devices.length === 0) {
            listContainer.innerHTML = '<p class="text-gray-500 italic">No devices found.</p>';
            return;
        }
        const ul = document.createElement('ul');
        ul.className = 'space-y-3';
        devices.forEach(d => {
            const li = document.createElement('li');
            li.className = 'flex items-center space-x-3 text-gray-800';
            li.innerHTML = `<i class="${d.icon} text-blue-700 text-xl w-6 text-center"></i> <span>${d.name}</span>`;
            ul.appendChild(li);
        });
        listContainer.innerHTML = '';
        listContainer.appendChild(ul);
    };

    const renderNetworkFavIcons = (devices) => {
        const container = document.getElementById('networkFavIconSection');
        const list = document.getElementById('networkFavIconList');
        if (!devices || devices.length === 0) {
            container.classList.add('hidden');
            return;
        }
        list.innerHTML = '';
        devices.forEach(d => {
            const li = document.createElement('li');
            li.className = 'flex flex-col items-center w-20 text-center';
            li.innerHTML = `
                <div class="bg-blue-700 text-white rounded-full w-12 h-12 flex items-center justify-center mb-1" title="${d.name}">
                    <i class="${d.icon} text-xl"></i>
                </div>
                <span class="text-xs truncate w-full">${d.name}</span>
            `;
            list.appendChild(li);
        });
        container.classList.remove('hidden');
    };

    // ENHANCEMENT: This function now handles deep linking and richer data.
    const displayResults = (data) => {
        document.getElementById('phoneOutput').textContent = data.phone;
        
        // --- Facebook Profile Section ---
        document.getElementById('fbProfilePic').src = data.fbData.profilePicUrl;
        document.getElementById('fbProfilePic').alt = `Profile picture of ${data.fbData.name}`;
        document.getElementById('fbName').textContent = data.fbData.name;
        
        // This is a "deep link". On mobile, it tells the OS to open the Facebook app.
        // It's a standard feature and does not access any data, it just opens the app.
        const appUrl = `fb://facewebmodal/f?href=${encodeURIComponent(data.fbData.profileUrl)}`;
        document.getElementById('fbAppLink').href = appUrl;

        // This is the standard web link, a fallback for desktop or if the app isn't installed.
        document.getElementById('fbWebLink').href = data.fbData.profileUrl;

        // Display the extra simulated details
        const extraDetailsContainer = document.getElementById('fbExtraDetails');
        extraDetailsContainer.innerHTML = `
            <div class="flex items-center"><i class="fas fa-home text-gray-500 w-5 mr-2"></i> From <strong>${data.fbData.hometown}</strong></div>
            <div class="flex items-center"><i class="fas fa-heart text-gray-500 w-5 mr-2"></i> ${data.fbData.status}</div>
        `;

        const hackResultDiv = document.getElementById('hackResult');
        if (data.hackStatus) {
            const success = data.hackStatus === 'Success';
            hackResultDiv.textContent = `Simulation Status: ${data.hackStatus}`;
            hackResultDiv.className = `mb-4 p-4 rounded-md font-semibold text-base ${success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            hackResultDiv.classList.remove('hidden');
        } else {
            hackResultDiv.classList.add('hidden');
        }

        renderNetworkFavIcons(data.networkDevices);
        resultSection.classList.remove('hidden');
        resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    };

    const openModal = (codeText) => {
        modalCode.textContent = codeText;
        codeModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        modalCloseBtn.focus();
    };

    const closeModal = () => {
        codeModal.classList.add('hidden');
        document.body.style.overflow = '';
        trackBtn.focus();
    };

    // --- History Management ---
    const loadHistory = () => {
        const history = JSON.parse(localStorage.getItem('gmasterHistory')) || [];
        if (history.length === 0) {
            noHistoryMsg.classList.remove('hidden');
            historyTableBody.innerHTML = '';
            clearHistoryBtn.classList.add('hidden');
            return;
        }
        
        noHistoryMsg.classList.add('hidden');
        clearHistoryBtn.classList.remove('hidden');
        historyTableBody.innerHTML = history.map((entry, index) => {
            const hackClass = entry.hackStatus === 'Success' ? 'text-green-700' : entry.hackStatus === 'Failed' ? 'text-red-700' : '';
            return `
                <tr class="${index % 2 === 0 ? 'bg-blue-50' : ''}">
                    <td class="border border-blue-200 px-3 py-2 font-mono text-sm">${entry.phone}</td>
                    <td class="border border-blue-200 px-3 py-2">${entry.fbName}</td>
                    <td class="border border-blue-200 px-3 py-2 text-xs">${new Date(entry.timestamp).toLocaleString()}</td>
                    <td class="border border-blue-200 px-3 py-2">${entry.phoneLocation.city}</td>
                    <td class="border border-blue-200 px-3 py-2 font-semibold ${hackClass}">${entry.hackStatus || '-'}</td>
                    <td class="border border-blue-200 px-3 py-2 text-center">${entry.networkDevices.length}</td>
                </tr>
            `;
        }).join('');
    };

    const saveToHistory = (entry) => {
        const history = JSON.parse(localStorage.getItem('gmasterHistory')) || [];
        history.unshift(entry);
        if (history.length > 50) history.pop();
        localStorage.setItem('gmasterHistory', JSON.stringify(history));
        loadHistory();
    };

    // --- Event Handlers ---
    const handleTrack = async (phoneValue, facebookValue) => {
        const originalBtnHTML = trackBtn.innerHTML;
        toggleButtonState(trackBtn, true, 'Tracking...');
        
        await new Promise(res => setTimeout(res, 1200)); // Simulate async delay

        const formattedPhone = formatPhoneNumber(phoneValue);
        const phoneLoc = estimatePhoneLocation(formattedPhone);
        const fbData = fetchFacebookProfileData(facebookValue);
        currentNetworkDevices = generateNetworkDevices();

        const data = {
            phone: formattedPhone,
            facebook: facebookValue,
            fbName: fbData.name,
            timestamp: Date.now(),
            phoneLocation: phoneLoc,
            fbLocation: fbData.fbLocation,
            hackStatus: null,
            networkDevices: currentNetworkDevices,
            fbData
        };

        displayResults(data);
        updateMap({ phone: phoneLoc, fb: fbData.fbLocation });
        saveToHistory(data);
        renderNetworkDevicesList(currentNetworkDevices);

        const codeText = `Record ID: ${Date.now()}\n- Phone: ${data.phone} (Est. Location: ${phoneLoc.city})\n- Facebook: ${data.fbData.name}\n- Profile URL: ${data.facebook}\n- Est. FB Location: ${data.fbData.fbLocation.city}\n- Simulated Status: ${data.fbData.status}\n- Network Devices Found: ${currentNetworkDevices.length}\n${currentNetworkDevices.map(d => `  - ${d.name} (${d.type})`).join('\n')}`;
        openModal(codeText);
        
        toggleButtonState(trackBtn, false, '', originalBtnHTML);
        showToast('Tracking complete!', 'success');
    };

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const phoneInput = form.phone.value.trim();
        const facebookInput = form.facebook.value.trim();
        
        if (!validateInput(phoneInput, /^(09|\+639)[0-9]{9}$/)) {
            showToast('Invalid Philippine phone number.', 'error');
            return;
        }
        if (!validateInput(facebookInput, /^https?:\/\/(www\.)?facebook\.com\/.+/i)) {
            showToast('Invalid Facebook profile URL.', 'error');
            return;
        }
        handleTrack(phoneInput, facebookInput);
    });

    generateBtn.addEventListener('click', () => {
        form.phone.value = generateRandomPhone();
        form.facebook.value = generateRandomFacebook();
        showToast('Demo data generated.', 'info');
        form.phone.focus();
    });

    hackBtn.addEventListener('click', async () => {
        const phoneInput = document.getElementById('hackPhone').value.trim();
        const facebookInput = document.getElementById('hackFacebook').value.trim();

        if (!validateInput(phoneInput, /^(09|\+639)[0-9]{9}$/) || !validateInput(facebookInput, /^https?:\/\/(www\.)?facebook\.com\/.+/i)) {
            showToast('Fill in valid target details.', 'error');
            return;
        }
        
        const originalBtnHTML = hackBtn.innerHTML;
        toggleButtonState(hackBtn, true, 'Exploiting...');
        await new Promise(res => setTimeout(res, 2000));

        const success = Math.random() < 0.3; // 30% success chance
        const formattedPhone = formatPhoneNumber(phoneInput);
        const phoneLoc = estimatePhoneLocation(formattedPhone);
        const fbData = fetchFacebookProfileData(facebookInput);
        const hackLoc = { ...phoneLoc, lat: phoneLoc.lat + (Math.random() - 0.5) * 0.1, lon: phoneLoc.lon + (Math.random() - 0.5) * 0.1 };
        currentNetworkDevices = generateNetworkDevices();

        const data = {
            phone: formattedPhone,
            facebook: facebookInput,
            fbName: fbData.name,
            timestamp: Date.now(),
            phoneLocation: phoneLoc,
            fbLocation: fbData.fbLocation,
            hackStatus: success ? 'Success' : 'Failed',
            networkDevices: currentNetworkDevices,
            fbData
        };

        displayResults(data);
        updateMap({ phone: phoneLoc, fb: fbData.fbLocation, hack: hackLoc });
        saveToHistory(data);
        renderNetworkDevicesList(currentNetworkDevices);

        toggleButtonState(hackBtn, false, '', originalBtnHTML);
        showToast(`Simulation ${success ? 'successful!' : 'failed.'}`, success ? 'success' : 'error');
    });

    generateHackBtn.addEventListener('click', () => {
        document.getElementById('hackPhone').value = generateRandomPhone();
        document.getElementById('hackFacebook').value = generateRandomFacebook();
        showToast('Target data generated.', 'info');
    });

    scanNetworkBtn.addEventListener('click', async () => {
        const originalBtnHTML = scanNetworkBtn.innerHTML;
        toggleButtonState(scanNetworkBtn, true, 'Scanning...');
        await new Promise(res => setTimeout(res, 1500));
        
        currentNetworkDevices = generateNetworkDevices();
        renderNetworkDevicesList(currentNetworkDevices);
        showToast(`${currentNetworkDevices.length} devices found.`, 'success');
        
        toggleButtonState(scanNetworkBtn, false, '', originalBtnHTML);
    });

    clearHistoryBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to delete all tracking history?')) {
            localStorage.removeItem('gmasterHistory');
            loadHistory();
            showToast('History cleared.', 'success');
        }
    });

    modalCloseBtn.addEventListener('click', closeModal);
    codeModal.addEventListener('click', (e) => (e.target === codeModal) && closeModal());
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !codeModal.classList.contains('hidden')) closeModal();
        if (e.ctrlKey && e.key === 'g') { e.preventDefault(); generateBtn.click(); }
    });
    
    // --- Initial Load ---
    loadHistory();
    initMap();
});
</script>
</body>
</html>
